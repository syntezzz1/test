
# Описание задачи

Автоматизировать установку Apache и Nginx на Debian 12 и Centos 7 с помощью Ansible.

Требования:
- по максимуму использовать встроенные возможности ansible, при использования модуля shell (или аналога) задача будет провалена.
- если действие зависит от ОС, то нужно детектировать ОС и выполнять корректные действия

**Оглавление:**

- [Введение](#введение)
- [Требования к уроку](#требования-к-уроку)
- [Установка Ansible на хост-машину](#установка-ansible-на-хост-машину)
- [Настройка подключения через SSH](#настройка-подключения-через-ssh)
- [Подготовка к запуску скрипта Ansible](#подготовка-к-запуску-скрипта-ansible)
- [Запуск скрипта](#запуск-скрипта)
- [Проверка работы](#проверка-работы)


# Введение

Ansible - это инструмент автоматизации для управления конфигурацией и выполнения задач на удаленных серверах. С помощью Ansible можно выполнять нижеописанные действия на нескольких серверах:

- устанавливать пакеты
- копировать файлы
- запускать команды
- управлять службами
- создавать пользователей
- настраивать файрволы
- другие

В Ansible есть несколько базовых сущностей, которые играют ключевую роль в выполнении автоматизированных задач:

**Модуль**

Модуль - это программа, которая выполняет конкретную задачу. Модули используются для управления ресурсами, такими как пакеты, файлы, службы, пользователи и т.д. Примеры модулей включают package (для кроссплатформенного управления пакетами), apt (для управления пакетами в Debian/Ubuntu), copy (для копирования файлов), service (для управления службами) и так далее.

Пример модуля для установки пакетов:

```
- name: install apache
  package:
    name: apache
    state: present
```

**Задача**

Задача - это описание действия, которое необходимо выполнить. Она состоит из вызова одного или нескольких модулей, а также опций и параметров, необходимых для выполнения задачи. 

Пример задачи копирования конфигурационного файла Nginx:

```
- name: copy custom nginx config file
  copy:
    src: /path/to/local/file.conf
    dest: /path/on/remote/server/file.conf
```

**Плейбук**

Плейбук - это текстовый файл в формате YAML, который содержит список задач для выполнения. Плейбуки позволяют структурировать и организовывать автоматизацию. Они могут включать переменные, условия, циклы и другие конструкции.

Пример плейбука, содержащего задачу:

```
---
- name: playbook example
  tasks:
    - name: install apache
      package:
        name: nginx
        state: present
```

**Инвентарь**

Инвентарь - это файл или группа файлов, в которых перечислены хосты. Инвентарь используется для указания того, на каких серверах выполнять задачи.

Пример инвентаря:

```
[web_servers]
centos_server ansible_host=192.168.31.183 ansible_user=root
debian_server ansible_host=192.168.31.89 ansible_user=starkov
```

Фактически скрипт Ansible должен выполнить задачи (содержащие модули) из плейбука, в соответствии с настройками хоста из инвентаря.

В данной инструкции описывается последовательность действий по установке веб-серверов Apache и веб-серверов Nginx на удаленные сервера с ОС Debian 12 и CentOS 7 с помощью скрипта Ansible.

# Требования к уроку

Предполагается, что виртуальные машины с ОС Debian 12 и CentOS 7 уже запущены в состоянии, идентичном состоянию сразу после их установки, то есть они должны быть в "голом" состоянии без дополнительных изменений или запущенных служб.

См. инструкцию к предыдущему уроку, если виртуальные машины не запущены.

# Установка Ansible на хост-машину

Ansible нужно запускать на отдельной хост-машине.

Выполните установку Ansible на свою хост-машину согласно [официальной документации](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).

# Настройка подключения через SSH

Ansible использует SSH для подключения к удаленным хостам, где выполняет задачи, описанные в плейбуке. Для подключения через SSH каждой виртуальной машине нужен собственный IP-адрес. По умолчанию IP-адреса обоих машин одинаковы, необходимо присвоить разные IP-адреса виртуальным машинам. Кроме того, адреса нужны для конфигурации Nginx, чтобы тот мог перенаправлять запросы на Apache, расположенные на разных серверах.

## Выдача root-прав для пользователя Debian

При стандартных настройках, выбранных во время установки ОС Debian, для root-пользователя запрещено логиниться через SSH, а службы должны запускаться с root-правами. Необходимо присвоить обычному пользователю Debian root-права.

Перейдите в терминал виртуальной машины с ОС Debian и откройте редактор root-пользователей:

```
sudo visudo
```

Предоставьте своему пользователю право использовать `sudo` без ввода пароля:

```
<your_debian_user> ALL=(ALL) NOPASSWD: ALL
```

> В CentOS нет вышеописанных ограничений. Данная инструкция и комплект поставки предполагают использование root-пользователя, от имени которого Ansible будет подключаться и выполнять свои задачи. При необходимости можно предоставить пользователю CentOS права на использование `sudo` аналогично вышеописанной инструкции.

## Настройка IP-адресов виртуальных машин

> Выполните нижеописанные действия для обеих виртуальных машин.

1. Перейдите в настройки виртуальной машины в раздел **Network**.

2. Выберите тип подключения **Bridget Adapter**, указав необходимый сетевой адаптер.

3. Перезапустите сетевой интерфейс с помощью команд, приведенных ниже:

CentOS:

```bash
systemctl restart network
```

Debian:

```bash
systemctl restart networking && systemctl restart NetworkManager
```

> В этом режиме виртуальная машина получает свой собственный IP-адрес в локальной сети, как если бы она была физическим устройством в этой сети.

## Прокидывание SSH-ключа на виртуальные машины

Необходимо прокинуть SSH-ключ хост-машины на обе виртуальные машины.

1. Узнайте уникальный IP-адрес виртуальной машины. Например, с помощью команды `ip a` (адрес обычно начинается с `192` в сетевом интерфейсе `enp3s0`)

2. Убедитесь, что на сервере установлен OpenSSH. 

> В зависимости от выбранных настроек при установке ОС, на Debian может присутствовать или отсутствовать OpenSSH. Если он отсутствует, то его можно установить, например, с помощью следующей команды:

```bash
apt install openssh-server
```

3. Откройте терминал на хостовой ОС и сгенерируйте пару ключей на хост-машине:

```bash
ssh-keygen
```

4. Скопируйте ключи на виртуальные машины:

```bash
ssh-copy-id root@<virtual_machine_centos_ip_addr>
```

```bash
ssh-copy-id user@<virtual_machine_debian_ip_addr>
```

# Подготовка к запуску скрипта Ansible

## Распаковка архива

Скачайте архив со скриптом Ansible и распакуйте в удобную директорию:

```
unzip task_ansible.zip
```

Для корректной работы скрипта требуются следующие файлы:

- `run_web_servers.yml` - плейбук Ansible
- `hosts` - инвентарь Ansible, в котором определены хосты и их атрибуты
- `default_nginx_config` - дефолтные настройки Nginx для обеих ОС

> В дефолтных настройках Nginx прописан шаблон, динамически настраиваемый секцию `upstream backend`, содержащую адреса виртуальных машин. С помощью этого шаблона можно не заполнять два раза IP-адреса виртуальных машин, достаточно лишь заполнить их в файле `hosts`, а шаблон автоматически считает IP-адреса из этого файла.

## Указание IP-адресов виртуальных машин

Замените следующие данные для каждой ОС в файле `hosts`:

- `<centos_ip_addr>` - IP-адрес сервера с CentOS
- `<debian_ip_addr>` - IP-адрес сервера с Debian
- `<debian_user>` - имя обычного пользователя с root правами для ОС Debian

# Запуск скрипта

Запустите скрипт из терминала с помощью следующей команды:

```bash
ansible-playbook -i hosts run_web_servers.yml
```

После запуска скрипта в логах терминала появится статус установки.

Пример фрагмента статуса установки:

```
PLAY [install apache and nginx on debian and centos] *************************************************************************************************************************************

TASK [gathering facts] *******************************************************************************************************************************************************************
ok: [debian_server]
ok: [centos_server]

TASK [allow traffic on ports 80 and 8080 on centos] ************************************************************************************************************************************
skipping: [debian_server] => (item=80) 
skipping: [debian_server] => (item=8080) 
skipping: [debian_server]
ok: [centos_server] => (item=80)
ok: [centos_server] => (item=8080)
...
```

> Некоторые комментарии к коду можно посмотреть в скрипте Ansible `run_web_servers.yml`. 

# Проверка работы

Для проверки работы можно запустить мониторинг командой `tail -f` и затем попробовать выполнить запросы к одному из веб-серверов Nginx. При этом будет видно в реальном времени появление новых логов доступа.

Запустите в отдельных терминалах нижеописанные команды. Для удобства терминалы можно переименовать в соответствии с ОС.

Логи Apache на Debian:

```bash
tail -f /var/log/apache2/access.log
```

Логи Nginx на Debian:

```bash
tail -f /var/log/nginx/access.log
```

Логи Apache на CentOS:

```bash
tail -f /var/log/httpd/access_log
```

Логи Nginx на CentOS:

```bash
tail -f /var/log/nginx/access.log
```

Теперь можно протестировать работу с помощью отправки GET-запроса на веб-сервера Nginx. Это можно сделать перейдя на страницу `http://<debian_or_centos_ip_address>:8080` в браузере (если есть графический интерфейс), или с помощью запроса ниже (может потребоваться утилита `curl`):

```bash
curl -I http://<debian_or_centos_ip_address>:8080
```

В браузере должна появиться дефолтная страница Apache, а в логах Apache на обоих ОС и в логах Nginx соответствующей ОС должны появиться записи вида: 

```bash
192.168.31.66 - - [22/Nov/2023:14:20:02 +0300] "GET / HTTP/1.1" 200 3041 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.660 YaBrowser/23.9.5.660 Yowser/2.5 Safari/537.36"
```

Это означает, что при отправке запроса на адрес веб-сервера Nginx, он проксирует запрос к веб-серверам Apache. 