# Описание задачи

**Задача**:

```
На виртуальные машины поставить Debian 12 и Centos 7. На них установить основной apache (backend) и проксирующий nginx (frontend). В nginx`е настроить балансировку на оба apache`а. Инструкцию написать в гит вторым уроком, сделать МР на меня. 

В инструкции должны быть пункты:
1) Виртуальная машина - как настроить для Вашей ОС, задать ресурсы. 
2) Дистрибутивы Linux - где брать, платно ли это, основные отличия двух перечисленных выше.
3) Когда задолбался писать команды вручную в окне ВМ - ssh и с чем его едят.
4) Как устанавливают ПО в Linux - make install, пакетные менеджеры.
5) Почему:
  а) в Debian поставились два веб сервера, но заработал только один.
  б) в Centos поставились два веб сервера, ни один не заработал.
  в) Как вы это узнали? Что им мешает? Как сделать, чтоб они запускались при старте системы? 
  г) в Debian дефолтная страница веб сервера открывается, а в Centos нет.
  д) Про сети нужно что-то знать и понимать.
6) Скриншоты или видео, где показана работа системы.

Для выполнения задания вам должно хватить (на каждую ВМ) 5 Гб места, 0,5 Гб ОЗУ, 1 vCPU. При установке ВМ сделать снимок. перед сдачей МР откатить ВМ на первоначальное состояние и по своей инструкции повторить настройку заново. 

Приветствуется краткость и лаконичность. Копировать весь man не надо. В описание задания есть мины и неточности.
```

**Оглавление:**

- [Введение](#введение)
- [Подготовка и настройка VirtualBox](#подготовка-и-настройка-virtualbox)
- [Запуск и настройка виртуальных машин](#запуск-и-настройка-виртуальных-машин)
- [Проверка работы](#проверка-работы)
- [Справочная информация](#справочная-информация) - описание про дистрибутивы, ssh, пакетные менеджеры
- [Ответы на вопросы](#ответы-на-вопросы) - ответы на вопросы **Почему:**

**Примечание:** Краткость и лаконичность - это замечательно. Но хорошая инструкция не должна быть сильно короткой. Я сократил насколько возможно, но на самом деле тут можно расширять и расширять описание, смотря для кого предназначена инструкция.

# Введение

В данной инструкции описывается последовательность действий по запуску виртуальных машин Debian 12 и CentOS 7 с последующей установкой веб-серверов Apache и веб-серверов Nginx на каждую ОС.

При отправке запроса в какой-либо веб-сервер Nginx, расположенный на 8080 порту соответствующей ОС, запрос будет балансироваться между двумя веб-серверами Apache, расположенными на 80 портах обеих виртуальных машин. Поскольку оба веб-сервера по умолчанию работают на 80 порту, то порты Nginx'a будут переопределены на 8080.

В данной инструкции будут использованы дефолтные страницы Nginx и Apache. При необходимости можно указать свои страницы (не описано в данной инструкции).

# Подготовка и настройка VirtualBox

В качестве ПО для виртуализации будет использовано VirtualBox. 

> Данная инструкция не отражает подробную информацию по настройке виртуальной машине и предназначена для опытных пользователей. Для более подробной информации обратитесь к официальной инструкции.

## Установка VirtualBox

1. Перейдите на [официальный сайт](https://www.virtualbox.org/wiki/Downloads) VirtualBox и выберите удобный способ установки в соответствии с вашей системой.

> Для Unix-систем на сайте доступны команды для установки VirtualBox непосредственно из терминала.

2. Установите и запустите VirtualBox.

## Скачивание дистрибутивов

Скачайте дистрибутивы с официального сайта:

- [CentOS](https://www.centos.org/download/)
- [Debian](https://www.debian.org/download)

> См. подробную информацию о дистрибутивах в разделе ["Дистрибутивы"](#дистрибутивы) справочной информации.

## Создание и первичная настройка виртуальных машин

> Последовательно выполните нижеописанные действия для обеих виртуальных машин.

1. Откройте VirtualBox.

2. Откройте окно создания новой виртуальной машины, указав **Имя виртуальной машины** и скачанный **ISO образ**. Для перечисленных ниже ОС укажите особые настройки:

- **CentOS**: Активируйте флаг `Skip Unattended Installation` для детальной настройки ОС во время установки
- **Debian**: Укажите **Имя пользователя** и **Пароль** для входа в систему

3. Выделите виртуальной машине 512 МБ **Основной памяти** и 1 **процессор CPU**.

> Обратите внимание, что это минимальная конфигурация для тестовой работы. При использовании графического интерфейса может потребоваться увеличение ресурсов (в т.ч. видеопамяти) для комфортной работы.

4. Перед началом создания будет отображена таблица с данными создаваемой виртуальной машины. Проверьте таблицу и приступите к установке. После установки ОС Debian, виртуальная машина будет автоматически запущена. Для установки CentOS 7 выполните действия, описанные ниже.

5. **CentOS**: Запустите виртуальную машину после создания и выберите **Install CentOS 7**.

6. **CentOS**: В окне **INSTALLATION SUMMARY** выберите язык. Затем перейдите в **INSTALLATION DESTINATION** и нажмите кнопку **Done**. Затем перейдите в **NETWORK & HOSTNAME**, включите Ethernet и нажмите кнопку **Done**. Нажмите кнопку **Begin installation**.

7. **CentOS**: Пока выполняется установка, укажите данные пользователя и пароль для администратора.

8. **CentOS**: После установки нажмите Reboot.

> Обратите внимание, что по умолчанию CentOS запускается без графического интерфейса. При необходимости можно установить интерфейс самостоятельно (не обязательно для выполнения данной работы).


# Запуск и настройка виртуальных машин

Убедитесь, что обе виртуальные машины запущены.

Все действия должны выполняться от root-пользователя. Перейти к root-пользователю можно с помощью следующей команды:

```
su -
```

## Создание слепков виртуальных машин

Слепок виртуальной машины позволяет вернуться в указанное состояние в любой момент времени. Слепок можно создать сразу после установки или после первичной настройки системы под свои нужды.

> Выполните нижеописанные действия для обеих виртуальных машин.

1. В главном меню сверху запущенной виртуальной машины выберите **Machine** > **Take snapshot...**.

2. Добавьте имя снимка и описание и нажмите **OK**.

3. В главном окне VirtualBox рядом с именем машины появится кнопка списка настроек. Для восстановление слепка виртуальной машины необходимо:
    - нажать кнопку **Shapshots**;
    - выбрать слепок;
    - нажать кнопку **Restore**. 


## Настройка IP-адресов

В конфигурации Nginx необходимо будет указать IP-адреса виртуальных машин. По умолчанию IP-адреса обоих машин одинаковы, необходимо присвоить разные IP-адреса виртуальным машинам.

Также разные IP-адреса нужны для подключения через SSH. Cм. подробную информацию в разделе ["Подключение через SSH"](#подключение-через-ssh).

> Выполните нижеописанные действия для обеих виртуальных машин.

1. Перейдите в настройки виртуальной машины в раздел **Network**.

2. Выберите тип подключения **Bridget Adapter**, указав необходимый сетевой адаптер.

3. Перезапустите сетевой интерфейс с помощью команд, приведенных ниже:

CentOS:

```bash
systemctl restart network
```

Debian:

```bash
systemctl restart networking
```

> В этом режиме виртуальная машина получает свой собственный IP-адрес в локальной сети, как если бы она была физическим устройством в этой сети.

## Получение и сохранение IP-адреса

Получите и сохраните IP-адрес каждой виртуальной машины. Это можно выполнить с помощью следующей команды:

```bash
ip a
```

IP-адрес должен отображаться в сетевом интерфейсе (например, `enp0s3`). Например, в выводе команды ниже сетевой адрес равен `192.168.31.91`:

```
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:06:ab:58 brd ff:ff:ff:ff:ff:ff
    inet 192.168.31.91/24 brd 192.168.31.255 scope global dynamic noprefixroute
```

> При необходимости можно выделить каждой виртуальной машине уникальный IP-адрес (не описано в данной инструкции).

## Настройка firewall в CentOS

По умолчанию оба Apache запускаются на порте 80, однако необходимо разрешить входящий трафик на порт 80 на сервере с CentOS, чтобы Nginx мог проксировать запросы к Apache на данном сервере. Также необходимо разрешить входящий трафик на порт 8080 чтобы была возможность просматривать дефолтную страницу в браузере с хостовой машины.

Разрешите трафик на порт 80 на CentOS с помощью следующей команды:

```bash
firewall-cmd --zone=public --add-port=80/tcp --permanent
```

Разрешите трафик на порт 8080 на CentOS с помощью следующей команды:

```bash
firewall-cmd --zone=public --add-port=8080/tcp --permanent
```

Перезагрузите firewall:

```bash
firewall-cmd --reload
```

## Установка и настройка ПО

Необходимо установить на обе виртуальные машины веб-сервера Apache и Nginx.

> См. подробную информацию об установке ПО в Linux в разделе ["Установка ПО в Linux"](#установка-по-в-linux) справочной информации.

### Apache в CentOS

Установите пакет `httpd`:

```bash
yum install httpd  
```

> Apache поставляется как часть пакета с именем `httpd`.

Запустите службу Apache и добавьте её в автозагрузку:

```bash
systemctl start httpd.service && systemctl enable httpd.service
```

Проверьте статус службы:

```bash
systemctl status httpd
```

### Apache в Debian

Установите пакет `apache2`:

```bash
apt install apache2
```

> По умолчанию службы в Debian автоматически запускаются и добавляются в автозагрузку при старте системы.

Проверьте статус службы:

```bash
systemctl status apache2.service
```

### Nginx в CentOS

Пакета `nginx` нет в стандартном репозитории CentOS. Нужно добавить официальный репозиторий Nginx в список используемых репозиториев.

> Инструкция ниже взята с официального сайта Nginx. См. [https://nginx.org/en/linux_packages.html#RHEL](https://nginx.org/en/linux_packages.html#RHEL) для более подробной информации.

Создайте следующий файл:

```bash
nano /etc/yum.repos.d/nginx.repo
```

Добавьте следующее содержимое в создаваемый файл:

```
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
```

Сохраните файл и установите пакет Nginx:

```bash
yum install nginx
```

#### Настройка Nginx в CentOS

Далее необходимо создать конфигурационный файл, указав в нем набор адресов, где запущены Apache.

По умолчанию Apache и Nginx работают на одном и том же порте. Для избежания конфликтов необходимо удалить дефолтный конфигурационный файл Nginx, в котором прослушивается 80 порт:

```bash
rm -f /etc/nginx/conf.d/default.conf
```

Добавьте свой конфигурационный файл с необходимым портом и настройками:

```bash
nano /etc/nginx/conf.d/vlabs.conf
```

```
upstream backend {
        server <centos_ip_address>:80;
        server <debian_ip_address>:80;
}

server {

    listen 8080;

    location / {
                proxy_pass http://backend;
    }
}
```

Запустите службу Nginx и добавьте её в автозагрузку:

```bash
systemctl start nginx.service && systemctl enable nginx.service
```

Проверьте статус службы:

```bash
systemctl status nginx.service
```

### Nginx в Debian

Установите пакет Nginx:

```bash
apt install nginx
```

После установки пакета система попытается автоматически запустить Nginx (поведение по умолчанию), однако столкнется с ошибкой, что по умолчанию 80 порт уже занят запущенным Apache. В следующем разделе мы удалим стандартный конфигурационный файл Nginx и изменим порт.

#### Настройка Nginx в Debian

Далее необходимо создать конфигурационный файл, указав в нем набор адресов, где запущены Apache.

По умолчанию Apache и Nginx работают на одном и том же порте. Для избежания конфликтов необходимо удалить дефолтный конфигурационный файл Nginx, в котором прослушивается 80 порт:

```bash
rm -f /etc/nginx/sites-enabled/default
```

Добавьте свой конфигурационный файл с необходимым портом и настройками:

```bash
nano /etc/nginx/sites-available/vlabs
```

```
upstream backend {
        server <centos_ip_address>:80;
        server <debian_ip_address>:80;
}

server {

    listen 8080;

    location / {
                proxy_pass http://backend;
    }
}
```

Включите использование конфигурационного файла с помощью создания символической ссылки:

```bash
ln -s /etc/nginx/sites-available/vlabs /etc/nginx/sites-enabled/
```

Перезапустите службу Nginx:

```bash
systemctl restart nginx.service
```

Проверьте статус службы:

```bash
systemctl status nginx.service
```

# Проверка работы

Для проверки работы можно запустить мониторинг командой `tail -f` и затем попробовать выполнить запросы к одному из веб-серверов Nginx. При этом будет видно в реальном времени появление новых логов доступа.

Запустите в отдельных терминалах нижеописанные команды. Для удобства терминалы можно переименовать в соответствии с ОС.

Логи Apache на Debian:

```bash
tail -f /var/log/apache2/access.log
```

Логи Nginx на Debian:

```bash
tail -f /var/log/nginx/access.log
```

Логи Apache на CentOS:

```bash
tail -f /var/log/httpd/access_log
```

Логи Nginx на CentOS:

```bash
tail -f /var/log/nginx/access.log
```

Теперь можно протестировать работу с помощью отправки GET-запроса на веб-сервера Nginx. Это можно сделать перейдя на страницу `http://<debian_or_centos_ip_address>:8080` в браузере (если есть графический интерфейс), или с помощью запроса ниже (может потребоваться утилита `curl`):

```bash
curl -I http://<debian_or_centos_ip_address>:8080
```

В браузере должна появиться дефолтная страница Apache, а в логах Apache на обоих ОС и в логах Nginx соответствующей ОС должны появиться записи вида: 

```bash
192.168.31.66 - - [22/Nov/2023:14:20:02 +0300] "GET / HTTP/1.1" 200 3041 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.660 YaBrowser/23.9.5.660 Yowser/2.5 Safari/537.36"
```

Это означает, что при отправке запроса на адрес веб-сервера Nginx, он проксирует запрос к веб-серверам Apache. Можно обратить внимание, что дефолтные страницы для Debian и для CentOS отличаются и меняются при обновлении страницы в браузере. Причем попадание на дефолтную страницу в CentOS определяется в логах кодом 404, а дефолтная страница в Debian определяется в логах кодом 200. Это нормальное поведение, если заменить дефолтную страницу в CentOS, то также будет возвращаться 200 код.

Убедиться в работоспособности выполнения запросов на Debian можно с помощью [этого видео](proof.mp4).

Убедиться в работоспособности выполнения запросов на CentOS можно с помощью [этого видео](proof-centos7.mp4).


# Справочная информация 

## Дистрибутивы

Оба дистрибутива CentOS и Debian распространяются бесплатно. В CentOS есть возможность платной поддержки.

Debian пишется волонтерами, а CentOS базируется на RHEL (коммерческая история) и считается более стабильным решением, имея больший цикл поддержки, чем Debian. Качество релизов у CentOS выше. Однако это не означает, что Debian хуже, чем CentOS, все зависит от кейсов. Например, на Debian намного больше пакетов и больше выбора каких-то репозиториев. Если пакеты пишутся самостоятельно и нет особой необходимости в большом количестве внешних пакетов, то можно остановиться на CentOS, для базовых задач пакетов будет достаточно.

## Установка ПО в Linux

По можно установить несколькими способами:

- с помощью пакетных менеджеров
- с помощью компиляции исходного кода (обычно располагается в архивах tar.gz/tar.bz) (не рекомендуется, см. раздел ["Компиляция и установка из исходного кода"](#компиляция-и-установка-из-исходного-кода))
- с помощью установочных sh-скриптов (обычно располагается в архивах tar.gz/tar.bz)
- с помощью запуска исполняемых файлов (обычно располагается в архивах tar.gz/tar.bz)
- другие

### Пакетные менеджеры

Пакеты на Linux устанавливаются с помощью пакетных менеджеров.

В CentOS используется пакетный менеджер **yum/dnf**. В Debian используется **apt**. Информация о пакетах хранится в репозиториях. Для каждой ОС свои репозитории и особенности в управлении пакетами. Репозитории можно как добавлять, так и удалять.

> Также существуют универсальные форматы упаковки (например, snap или flatpak), которые могут использоваться на различных ОС, но лучше использовать специфичные форматы для используемой ОС.

Общий принцип установки пакетов:

- поиск пакета в репозитории
- загрузка пакета из репозитория
- установка загруженного пакета
- настройка/обновление

### Компиляция и установка из исходного кода

**Важно!** Установка из исходного кода может изменять системные файлы, что может вызвать конфликты и нестабильность. Крайне рекомендуется устанавливать ПО через [пакетные менеджеры](#пакетные-менеджеры). Если же очень требуется собирать пакет из исходного кода, то нужно обратиться к официальной документации. Везде есть подводные камни, о которых лучше всего расскажут в официальной инструкции. Главное не забыть сначала скомпилировать через **make**, а уже потом выполнять **make install**.

## Подключение через SSH

Ниже приведена инструкция по подключению хоста к виртуальной машине VirtualBox через SSH.

1. Откройте сетевой мост для получения уникального IP-адреса (см. раздел ["Настройка IP-адресов"](#настройка-ip-адресов)).

2. Узнайте уникальный IP-адрес виртуальной машины. Например, с помощью команды `ip a`.

3. Убедитесь, что на сервере установлен OpenSSH. 

> На Debian по умолчанию нет OpenSSH. Его можно установить, например, с помощью следующей команды:

```bash
apt install openssh-server
```

4. Откройте терминал на хостовой ОС и подключитесь к виртуальной машине c CentOS через SHH с помощью следующей команды:

```bash
ssh root@<virtual_machine_centos_ip_addr>
```

5. Откройте терминал на хостовой ОС и подключитесь к виртуальной машине c Debian через SHH с помощью следующей команды:

```bash
ssh <user>@<virtual_machine_centos_ip_addr>
```

6. После подключения залогиньтесь под root-пользователем:

```
su -
```

> Вышеописанные действия для ssh-подключения к Debian обусловлены тем, что для root-пользователя по умолчанию запрещено логиниться через SSH.

При первом подключении системы попросят подтвердить ключ SSH и ввести пароль. Чтобы постоянно не вводить пароль можно сгенерировать пару ключей на хосте и прокинуть публичный ключ на виртуальную машину.

Это можно сделать с помощью следующих команд:

1. Генерация пары ключей на локальном ПК:

```bash
ssh-keygen
```

2. Копирование ключей на виртуальные машины:

```bash
ssh-copy-id root@<virtual_machine_centos_ip_addr>
```

```bash
ssh-copy-id user@<virtual_machine_debian_ip_addr>
```

> См. подробную инструкцию по прокидыванию ssh-ключей в интернете.


# Ответы на вопросы

### 1. Почему в Debian поставились два веб сервера, но заработал только один

Скорее всего конфликт портов. По дефолту они оба слушают 80 порт. Для этого мы переопределили порт в инструкции.

### 2. Почему в Centos поставились два веб сервера, ни один не заработал.

Надо смотреть логи. Возможно проблема в файрволле. Нужно открыть входящий трафик для портов как мы сделали в инструкции.

### 3. Как вы это узнали? Что им мешает? Как сделать, чтоб они запускались при старте системы?

Узнал я это когда увидел, что нихрена не работает)

После этого идем смотрим статус службы с помощью `systemctl status <service_name>.service`. Там может быть приведена базовая информация, которая наведет на умные мысли. Например, сразу можно понять работает ли служба в принципе или она работает не правильно. Если не работает в принципе, то можно посмотреть логи службы. Там может быть сказано, что порт занят и поэтому лежит.

Если работает, но не правильно, то можно посмотреть специальные логи службы (если имеются) в `/var/log/apache2/error.log`.

Для добавления в автозапуск используем `systemctl enable`. Но в Debian они автоматически добавляются в автозапуск.

### 4. Почему в Debian дефолтная страница веб сервера открывается, а в Centos нет.

Открытие дефолтной страницы - самый явный показатель того, что веб-сервер работает. Если она не открывается, то мб служба вообще не работает. Идем в логи и смотрим статус и решаем исходя из этого. Может опять занят порт или криво настроили firewall.

Также надо убедиться, что веб-сервер слушает на правильном IP-адресе и порту, особенно если тачка имеет несколько сетевых интерфейсов.

### 5. Почему про сети нужно что-то знать и понимать.

Без знания сетей невозможно было бы сделать это задание) Мы бы не смогли настроить IP-адреса, firewall, подключиться по ssh.

Да и в целом когда речь идет про веб-сервера, то знание сетей бесценно.













