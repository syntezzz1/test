
# Подготовительный этап

Задачи:

1) Разделить компоуз на 3 части -  реестра, гитлаб раннера и сервера.
2) Проверить работу предыдущей таски (- echo ok)
3) Сделать раннер, который может собирать докер образы.
4) Сделать проект, который:
а) Собрает образы из задачи с первым компоузом (1 nginx + 2 apache).
б) Пушит собранные образы в свой реестр.
в) Формирует артефакт состоящий из компоуза и вспомогательных файлов для запуска предсобранных (они не должны в нём собираться никоим образом, только качаться из реестра) образов.
5) Сделать ветку в проекте, где отличия будут только в заглавной веб странице. 

Т. е. на выходе будет два артефакта. После запуска первого нам покажут страницу "А", после второго "Б".

## Перенаправление трафика

Для того, чтобы работало через красивый `example.local`, а не IP-адрес, надо перенаправить трафик с 127.0.0.1 на локальный GitLab сервер.

- открываем hosts:

```bash
sudo nano /etc/hosts
```

- добавляем `example.local` в `hosts`:
```
127.0.0.1       example.local
```

## Запуск Docker Compose

Переходим в директорию с Docker Compose:

```bash
cd task/main/
```

Запускаем Docker Compose с помощью следующей команды:

```bash
docker-compose -f gitlab-runner.yml -f gitlab-server.yml -f registry-server-ui.yml up -d
```

Ждем пока все сервисы запустятся:

```bash
docker ps
```

## Создание раннера в интерфейсе

Авторизируемся в интерфейсе GitLab по следующему адресу, используя логин `root` и пароль из переменной `GITLAB_ROOT_PASSWORD` в `.env`:

```
http://example.local/
```

Создаем новый раннер, указывая любой удобный тег (например, `main-tag`), по следующему адресу:

```
http://example.local/admin/runners/new
```

После создания будет выдан `url` и `token`, которые должны быть использованы использованы при регистрации раннера.

## Регистрация раннера

Подключаемся к контейнеру, в котором будем регистрировать раннер:

```bash
docker exec -it main_gitlab-runner_1 bash
```

Регистрируем раннер с помощью следующей команды:

```bash
gitlab-runner register \
  --url "http://example.local/" \
  --token "<your token>" 
```

В имени раннера пишем `docker-runner-main`. В поле `executor` пишем `docker`. В поле `docker-image` пишем `docker:stable`.


После регистрации раннер будет отображаться как **Online** по адресу [http://example.local/admin/runners/](http://example.local/admin/runners/).

## Костыль

Поскольку раннер и сервер запускаются в разных сетевых пространствах, они не могут непосредственно общаться друг с другом, используя localhost или имена хостов, определенные внутри их собственных контейнеров. Это связано с тем, что Docker по умолчанию изолирует сетевое пространство каждого контейнера.

У нас же раннер пытается соединиться с `example.local`, но не может найти хост, т.к. этот хост мы определили только у нас (см. выше), но не в контейнере.

Нам теперь надо определить это и в контейнере, поэтому нужно зайти на раннер...:

```bash
docker exec -it main_gitlab-runner_1 bash
```

... открыть файл конфигурации раннера ...:

```bash
vi /etc/gitlab-runner/config.toml
```

... и добавить в секцию нашего раннера (`docker-runner`) следующее:

```
network_mode = "host"
```

После этого раннер станет использовать данные из хостового `etc/hosts`.



## Создание и выполнение проекта

Создаем новый проект по адресу:

```
http://example.local/projects/new
```

Переносим содержимое директории `to_gitlab` в Gitlab.

Наблюдаем создание и публикацию образов в регистри.

Скачиваем артефакт.

Переходим в директорию `it_new` и выполняем команду `docker-compose up`.

Переходим по адресу `http://localhost:8081/` и видим стартовую страницу.

Обратите внимание, что NGINX запускается на 8081 порте, т.к. на 8080 порте расположен регистри и могут возникнуть конфликты, когда запускается на одной машине.

## Решение проблем

Если наблюдается следующее поведение при сборке образов на раннере...:

```bash
$ docker build -t debian-image:0.0.1 ./it_new/debian
error during connect: Post http://docker:2375/v1.40/build?buildargs=%7B%7D&cachefrom=%5B%5D&cgroupparent=&cpuperiod=0&cpuquota=0&cpusetcpus=&cpusetmems=&cpushares=0&dockerfile=Dockerfile&labels=%7B%7D&memory=0&memswap=0&networkmode=default&rm=1&session=105j1opdnx02zi32lyx1zsdt5&shmsize=0&t=debian-image%3A0.0.1&target=&ulimits=null&version=1: dial tcp: lookup docker on 127.0.0.53:53: server misbehaving
```

... то это означает, что по каким-то неизвестным причинам Docker клиент пытается подключиться к Docker демону по адресу docker:2375, что указывает на TCP соединение, а не на Unix сокет. Решением проблемы может быть проброс Unix сокета Docker демона прямо в файле конфигурации раннера:

```bash
docker exec -it main_gitlab-runner_1 bash
vi /etc/gitlab-runner/config.toml
```

```
volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/cache"]
```
